<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign Up - CashSnap</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen flex items-center justify-center p-4">
  
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8">
    <!-- Logo -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-gray-900">üí∏ CashSnap</h1>
      <p class="text-gray-600 mt-2">Track expenses via WhatsApp</p>
    </div>

    <!-- Step Indicator -->
    <div class="flex justify-center mb-8">
      <div class="flex items-center">
        <div id="step1-indicator" class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center font-bold">1</div>
        <div class="w-16 h-1 bg-gray-300 mx-2"></div>
        <div id="step2-indicator" class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-bold">2</div>
        <div class="w-16 h-1 bg-gray-300 mx-2"></div>
        <div id="step3-indicator" class="w-8 h-8 rounded-full bg-gray-300 text-gray-600 flex items-center justify-center font-bold">3</div>
      </div>
    </div>

    <!-- Step 1: Basic Info -->
    <div id="step1" class="space-y-4">
      <h2 class="text-xl font-semibold mb-4">Create Your Account</h2>
      
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
        <input 
          type="text" 
          id="name" 
          placeholder="John Doe"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
          required
        >
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
        <input 
          type="email" 
          id="email" 
          placeholder="you@example.com"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
          required
        >
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">WhatsApp Number</label>
        <input 
          type="tel" 
          id="phone" 
          placeholder="+92 300 1234567"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
          required
        >
        <p class="text-xs text-gray-500 mt-1">Include country code (e.g., +92)</p>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Choose Plan</label>
        <div class="space-y-2">
          <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-green-500">
            <input type="radio" name="plan" value="free" checked class="mr-3">
            <div>
              <div class="font-semibold">Free</div>
              <div class="text-sm text-gray-600">20 expenses/month</div>
            </div>
          </label>
          
          <label class="flex items-center p-4 border-2 border-green-500 rounded-lg cursor-pointer bg-green-50">
            <input type="radio" name="plan" value="pro" class="mr-3">
            <div>
              <div class="font-semibold">Pro - $50/year</div>
              <div class="text-sm text-gray-600">Unlimited expenses + receipts</div>
            </div>
          </label>
        </div>
      </div>

      <button 
        onclick="sendCode()" 
        id="sendCodeBtn"
        class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg transition duration-200"
      >
        Continue
      </button>
    </div>

    <!-- Step 2: Verification Code -->
    <div id="step2" class="hidden space-y-4">
      <h2 class="text-xl font-semibold mb-4">Enter Verification Code</h2>
      
      <p class="text-gray-600 mb-4">
        We sent a 4-digit code to your WhatsApp.
      </p>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Verification Code</label>
        <input 
          type="text" 
          id="code" 
          placeholder="1234"
          maxlength="4"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg text-center text-2xl tracking-widest focus:ring-2 focus:ring-green-500 focus:border-transparent"
          required
        >
      </div>

      <button 
        onclick="verifyCode()" 
        id="verifyBtn"
        class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg transition duration-200"
      >
        Verify & Continue
      </button>

      <button 
        onclick="goToStep(1)" 
        class="w-full text-gray-600 hover:text-gray-900 font-medium"
      >
        ‚Üê Back
      </button>
    </div>

    <!-- Step 3: Success -->
    <div id="step3" class="hidden space-y-4 text-center">
      <div class="text-6xl mb-4">üéâ</div>
      <h2 class="text-2xl font-bold text-gray-900">Welcome to CashSnap!</h2>
      
      <div id="freeSuccess" class="hidden">
        <p class="text-gray-600 mb-6">Your free account is ready!</p>
        
        <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-6">
          <h3 class="font-semibold text-lg mb-3">Start Tracking Now:</h3>
          <ol class="text-left space-y-2 text-gray-700">
            <li>1. Open WhatsApp</li>
            <li>2. Message: <span class="font-mono bg-gray-100 px-2 py-1 rounded">+1 415 523 8886</span></li>
            <li>3. Send: <span class="font-mono bg-gray-100 px-2 py-1 rounded">join shadow-market</span></li>
            <li>4. Start texting expenses!</li>
          </ol>
        </div>

        <button 
          onclick="window.open('https://wa.me/14155238886', '_blank')"
          class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg transition duration-200"
        >
          Open WhatsApp
        </button>
      </div>

      <div id="proSuccess" class="hidden">
        <p class="text-gray-600 mb-6">Complete payment to activate Pro!</p>
        
        <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 mb-6">
          <p class="text-sm text-gray-700">
            You'll receive a Payoneer invoice at:<br>
            <span class="font-semibold" id="userEmail"></span>
          </p>
        </div>

        <button 
          id="paymentBtn"
          class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg transition duration-200"
        >
          Proceed to Payment
        </button>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-8 text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto mb-4"></div>
        <p class="text-gray-700">Loading...</p>
      </div>
    </div>

    <!-- Error Message -->
    <div id="error" class="hidden mt-4 bg-red-50 border-2 border-red-200 rounded-lg p-4">
      <p class="text-red-700 text-sm" id="errorMessage"></p>
    </div>
  </div>

  <script>
    const API_URL = 'https://cashsnap-api.onrender.com/api';
    let userData = {};

    function showLoading(show) {
      document.getElementById('loading').classList.toggle('hidden', !show);
    }

    function showError(message) {
      const errorDiv = document.getElementById('error');
      const errorMsg = document.getElementById('errorMessage');
      errorMsg.textContent = message;
      errorDiv.classList.remove('hidden');
      setTimeout(() => errorDiv.classList.add('hidden'), 5000);
    }

    function goToStep(step) {
      document.getElementById('step1').classList.add('hidden');
      document.getElementById('step2').classList.add('hidden');
      document.getElementById('step3').classList.add('hidden');
      document.getElementById(`step${step}`).classList.remove('hidden');

      // Update indicators
      for (let i = 1; i <= 3; i++) {
        const indicator = document.getElementById(`step${i}-indicator`);
        if (i < step) {
          indicator.classList.remove('bg-gray-300', 'text-gray-600');
          indicator.classList.add('bg-green-500', 'text-white');
        } else if (i === step) {
          indicator.classList.remove('bg-gray-300', 'text-gray-600');
          indicator.classList.add('bg-green-500', 'text-white');
        } else {
          indicator.classList.remove('bg-green-500', 'text-white');
          indicator.classList.add('bg-gray-300', 'text-gray-600');
        }
      }
    }

    async function sendCode() {
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const plan = document.querySelector('input[name="plan"]:checked').value;

      if (!name || !email || !phone) {
        showError('Please fill in all fields');
        return;
      }

      // Validate phone format
      if (!phone.startsWith('+')) {
        showError('Phone number must include country code (e.g., +92)');
        return;
      }

      userData = { name, email, phone, plan };

      showLoading(true);

      try {
        const response = await fetch(`${API_URL}/auth/send-code`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone_number: phone })
        });

        const data = await response.json();
        showLoading(false);

        if (data.success) {
          goToStep(2);
        } else {
          showError(data.error || 'Failed to send code');
        }
      } catch (error) {
        showLoading(false);
        showError('Network error. Please try again.');
        console.error(error);
      }
    }

    async function verifyCode() {
      const code = document.getElementById('code').value.trim();

      if (code.length !== 4) {
        showError('Please enter a 4-digit code');
        return;
      }

      showLoading(true);

      try {
        const response = await fetch(`${API_URL}/auth/verify-code`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            phone_number: userData.phone,
            code: code,
            email: userData.email,
            name: userData.name,
            plan: userData.plan
          })
        });

        const data = await response.json();
        showLoading(false);

        if (data.success) {
          // Save token
          localStorage.setItem('cashsnap_token', data.data.token);
          localStorage.setItem('cashsnap_user', JSON.stringify(data.data.user));

          // Show success
          goToStep(3);

          if (userData.plan === 'free') {
            document.getElementById('freeSuccess').classList.remove('hidden');
          } else {
            document.getElementById('userEmail').textContent = userData.email;
            document.getElementById('proSuccess').classList.remove('hidden');
            
            // Setup payment button
            document.getElementById('paymentBtn').onclick = async () => {
              await createPayment(data.data.token);
            };
          }
        } else {
          showError(data.error || 'Invalid code');
        }
      } catch (error) {
        showLoading(false);
        showError('Network error. Please try again.');
        console.error(error);
      }
    }

    async function createPayment(token) {
      showLoading(true);

      try {
        const response = await fetch(`${API_URL}/payment/create`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            plan_type: 'pro_yearly',
            payment_method: 'payoneer'
          })
        });

        const data = await response.json();
        showLoading(false);

        if (data.success) {
          // Redirect to payment URL
          window.location.href = data.data.payment_url;
        } else {
          showError(data.error || 'Failed to create payment');
        }
      } catch (error) {
        showLoading(false);
        showError('Network error. Please try again.');
        console.error(error);
      }
    }
  </script>
</body>
</html>
